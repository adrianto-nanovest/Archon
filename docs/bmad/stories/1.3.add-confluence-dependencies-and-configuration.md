# Story 1.3: Add Confluence Dependencies and Configuration

## Status
Done

## Story

**As a** backend developer,
**I want** to add required dependencies and environment variables for Confluence integration,
**so that** the system has all necessary libraries and configuration for API connectivity.

## Acceptance Criteria

1. Add to `python/pyproject.toml` dependencies: `atlassian-python-api = "^3.41.0"`, `markdownify = "^0.11.6"`
2. Update `.env.example` with: `CONFLUENCE_BASE_URL`, `CONFLUENCE_API_TOKEN`, `CONFLUENCE_EMAIL`
3. Update `python/src/server/config/config.py` to load Confluence environment variables
4. Add Confluence API token encryption support in `archon_settings` table (bcrypt-hashed)
5. Document environment variables in `CLAUDE.md` and `brownfield-architecture.md`

## Tasks / Subtasks

- [x] **Task 1: Verify Dependencies in pyproject.toml** (AC: 1)
  - [x] Check if `atlassian-python-api>=3.41.0` already exists in `[dependency-groups.server]` section
  - [x] Check if `markdownify>=0.11.0` already exists in `[dependency-groups.server]` section
  - [x] If missing, add both dependencies to the `server` dependency group
  - [x] Run `uv sync --group all` to verify successful installation
  - [x] Add same dependencies to `all` group if it exists for comprehensive testing

- [x] **Task 2: Create or Update .env.example with Confluence Variables** (AC: 2)
  - [x] Add `CONFLUENCE_BASE_URL` with example: `https://your-company.atlassian.net/wiki`
  - [x] Add `CONFLUENCE_API_TOKEN` with comment: "# Generate at https://id.atlassian.com/manage-profile/security/api-tokens"
  - [x] Add `CONFLUENCE_EMAIL` with example: "your-email@company.com"
  - [x] Add section comment: "# Confluence Integration (Optional - required for Confluence sync)"
  - [x] Document that all three variables are optional at startup (can be configured via Settings API)

- [x] **Task 3: Extend EnvironmentConfig Dataclass** (AC: 3)
  - [x] Open `python/src/server/config/config.py`
  - [x] Add three optional fields to `EnvironmentConfig` dataclass:
    - `confluence_base_url: str | None = None`
    - `confluence_api_token: str | None = None`
    - `confluence_email: str | None = None`
  - [x] Load these values in `load_environment_config()` function using `os.getenv()`
  - [x] Make all Confluence variables optional (no ConfigurationError if missing)
  - [x] Add validation function `validate_confluence_config()` to check URL format if provided

- [x] **Task 4: Create Confluence URL Validation Function** (AC: 3)
  - [x] Create `validate_confluence_url(url: str) -> bool` function in `config.py`
  - [x] Check URL starts with `https://` (Confluence Cloud requires HTTPS)
  - [x] Check URL contains `.atlassian.net` or is a custom domain
  - [x] Raise `ConfigurationError` with clear message if invalid
  - [x] Return `True` if valid
  - [x] Call this validator only if `confluence_base_url` is provided

- [x] **Task 5: Document API Token Encryption in Settings Service** (AC: 4)
  - [x] Review existing `archon_settings` table schema (already has `encrypted_value` column)
  - [x] Verify bcrypt encryption pattern in existing settings code (CORRECTION: Uses Fernet encryption, not bcrypt)
  - [x] Document in code comments that Confluence API token will use `encrypted_value` column
  - [x] Add example setting key: `confluence_api_token` with `is_encrypted = TRUE`
  - [x] Note: No code changes needed here - encryption already implemented for API keys

- [x] **Task 6: Update CLAUDE.md with Confluence Environment Variables** (AC: 5)
  - [x] Open `CLAUDE.md` file at project root
  - [x] Find "Environment Variables" section
  - [x] Add subsection: "### Confluence Integration (Optional)"
  - [x] Document all three variables with descriptions and examples
  - [x] Note that variables can be set via Settings UI as alternative to .env
  - [x] Add security note: "API token stored encrypted (Fernet encryption) in archon_settings table"

- [x] **Task 7: Update Brownfield Architecture Documentation** (AC: 5)
  - [x] Open `docs/bmad/brownfield-architecture/integration-points-and-external-dependencies.md`
  - [x] Update Confluence API Integration section from "To Implement" to "Implemented"
  - [x] Add environment variable documentation to architecture
  - [x] Update dependency list with actual versions (atlassian-python-api>=3.41.0, markdownify>=0.11.0)
  - [x] Add configuration pattern example showing optional vs required variables
  - [x] Document implementation files and test locations
  - [x] Update service status in external services table from "Planned" to "Active"

- [x] **Task 8: Write Unit Tests for Confluence Config Validation** (Testing section)
  - [x] Create test file: `python/tests/server/config/test_config_confluence.py`
  - [x] Test `validate_confluence_url()` with valid URLs (`.atlassian.net`, custom domains)
  - [x] Test URL validation with invalid URLs (HTTP, malformed, empty)
  - [x] Test `load_environment_config()` with Confluence variables set
  - [x] Test `load_environment_config()` with Confluence variables missing (should not fail)
  - [x] Test URL validation only runs when `confluence_base_url` is provided
  - [x] Use pytest fixtures to mock environment variables

- [x] **Task 9: Verify Integration with Settings API** (AC: 4)
  - [x] Review existing Settings API endpoints that handle encrypted values
  - [x] Verify settings service can store/retrieve encrypted Confluence API token
  - [x] Document the API pattern for setting Confluence credentials:
    - POST `/api/credentials` with key `CONFLUENCE_API_TOKEN`, value `<token>`, `is_encrypted=true`
  - [x] Add integration test that encrypts and decrypts a sample API token

## Dev Notes

### Previous Story Insights
- **Story 1.1 Completion**: Migration 010 created Confluence database schema
  - `confluence_pages` table established with indexes
  - Hybrid schema approach validated (metadata + unified chunks)
  - Self-recording migration pattern used

- **Story 1.2 Completion**: ConfluenceClient API wrapper implemented
  - Dependencies `atlassian-python-api>=3.41.0` and `markdownify>=0.11.0` already added to `pyproject.toml`
  - ConfluenceClient class created with authentication, CQL search, retry logic
  - Integration tests configured with environment variables
  - **KEY INSIGHT**: Dependencies likely already exist! This story focuses on *configuration* and *documentation*.

### Architecture Context: Configuration Management

**Source:** [Architecture: High Level](docs/bmad/brownfield-architecture/high-level-architecture.md#actual-tech-stack)

**Configuration Pattern:**
Archon uses environment variables loaded via `python-dotenv` with validation in `config.py`:
- Required variables (SUPABASE_URL, SUPABASE_SERVICE_KEY) raise `ConfigurationError` at startup
- Optional variables (OPENAI_API_KEY, Confluence variables) can be set later via Settings API
- Sensitive values (API tokens) stored encrypted in `archon_settings` table using bcrypt

**Existing Configuration Structure:**
```python
@dataclass
class EnvironmentConfig:
    """Configuration loaded from environment variables."""
    supabase_url: str
    supabase_service_key: str
    port: int
    openai_api_key: str | None = None
    host: str = "0.0.0.0"
    transport: str = "sse"
    # TO ADD: confluence_base_url, confluence_api_token, confluence_email
```

**Validation Pattern:**
- URL validation: `validate_supabase_url()` checks HTTPS, localhost exceptions, format
- API key validation: `validate_openai_api_key()` checks format (e.g., `sk-` prefix)
- Confluence URL validation should follow similar pattern (HTTPS required for Confluence Cloud)

### Confluence Configuration Requirements

**Source:** [Architecture: Confluence Integration](docs/bmad/brownfield-architecture/confluence-integration-architecture.md)

**Confluence Cloud Authentication:**
- **Base URL**: `https://<your-domain>.atlassian.net/wiki`
- **API Token**: Generate at https://id.atlassian.com/manage-profile/security/api-tokens
- **Email**: User email associated with API token (required for token authentication)

**Configuration Strategy (Two-Tier Approach):**
1. **Environment Variables (.env)**: Optional, for automated/scripted setups
2. **Settings API (UI)**: Primary method, stores encrypted values in `archon_settings` table

**Why Optional at Startup?**
- Users may not have Confluence integration initially
- Allows Archon to run without Confluence configured
- Confluence source creation will fail gracefully with clear error if credentials missing

### File Locations and Project Structure

**Source:** [Architecture: Source Tree](docs/bmad/brownfield-architecture/source-tree-and-module-organization.md)

**Files to Modify:**
- `python/pyproject.toml` - Dependencies (may already be updated)
- `.env.example` - Environment variable template
- `python/src/server/config/config.py` - Configuration loading and validation
- `CLAUDE.md` - User-facing environment variable documentation
- `docs/bmad/brownfield-architecture/integration-points-and-external-dependencies.md` - Architecture docs

**New Files (Tests):**
- `python/tests/server/config/test_config_confluence.py` - Configuration validation tests

### Dependency Details

**Source:** [Architecture: Confluence Integration](docs/bmad/brownfield-architecture/confluence-integration-architecture.md#dependencies-to-add)

**Confluence Dependencies:**
```toml
# python/pyproject.toml - [dependency-groups.server]
atlassian-python-api = "^3.41.0"  # Confluence REST API client SDK
markdownify = "^0.11.6"           # HTML to Markdown conversion
```

**Dependency Status Check:**
From Story 1.2 completion notes, these dependencies were already added. This story verifies they exist and are properly installed.

**Installation Verification:**
```bash
cd python
uv sync --group all              # Install all dependencies
uv run python -c "import atlassian; import markdownify; print('âœ… Dependencies installed')"
```

### Environment Variable Examples

**Confluence Cloud URL Patterns:**
- Standard: `https://company-name.atlassian.net/wiki`
- Custom domain (rare): `https://wiki.company.com`
- **DO NOT** include space paths (e.g., `/spaces/DEVDOCS`) - base URL only

**API Token Format:**
- Long alphanumeric string (typically 24+ characters)
- Generated per user account
- Does NOT start with specific prefix (unlike OpenAI `sk-` keys)
- Treat as sensitive credential (never log, always encrypt)

**Email Format:**
- Must match Atlassian account email
- Used for API authentication context
- Example: `developer@company.com`

### Settings API Integration Pattern

**Source:** [Architecture: Data Models](docs/bmad/brownfield-architecture/data-models-and-apis.md#configuration-tables)

**`archon_settings` Table Schema:**
```sql
CREATE TABLE archon_settings (
  id UUID PRIMARY KEY,
  key VARCHAR(255) UNIQUE NOT NULL,
  value TEXT,                    -- Plain text config
  encrypted_value TEXT,          -- Bcrypt-hashed sensitive data
  is_encrypted BOOLEAN DEFAULT FALSE,
  category VARCHAR(100),         -- 'rag_strategy', 'api_keys', 'monitoring', etc.
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**Confluence Settings Keys:**
- `confluence_base_url` - Plain text (is_encrypted = FALSE)
- `confluence_email` - Plain text (is_encrypted = FALSE)
- `confluence_api_token` - **Encrypted** (is_encrypted = TRUE, stored in `encrypted_value` column)

**Settings API Endpoints:**
```
GET  /api/settings         # List all settings
POST /api/settings         # Create or update setting
GET  /api/settings/{key}   # Get specific setting
```

**Encryption Note:**
Archon already has bcrypt encryption for API keys (OpenAI, etc.). Confluence API token follows the same pattern. No new encryption code needed - just use existing `is_encrypted` flag.

### Error Handling Strategy

**Source:** [CLAUDE.md](CLAUDE.md#error-handling)

**Beta Development Principle: Fail Fast and Loud**

**Missing Confluence Configuration â†’ FAIL GRACEFULLY:**
- Do NOT raise `ConfigurationError` at startup if Confluence variables missing
- Confluence integration is optional feature
- When user tries to create Confluence source without credentials:
  - Raise clear error: "Confluence credentials not configured. Please set CONFLUENCE_BASE_URL, CONFLUENCE_API_TOKEN, and CONFLUENCE_EMAIL in Settings or .env file."
  - Include link to Settings UI for configuration

**Invalid Confluence URL â†’ FAIL IMMEDIATELY:**
- If `confluence_base_url` provided but invalid format:
  - Raise `ConfigurationError` at startup with clear message
  - Example: "Invalid CONFLUENCE_BASE_URL: must use HTTPS and be a valid URL (e.g., https://company.atlassian.net/wiki)"

**Logging Requirements:**
- Log successful Confluence configuration load at INFO level (do not log API token!)
- Log validation errors at ERROR level with context
- Mask sensitive data in all logs (API token, email domain optional)

### Testing Standards

**Source:** [Architecture: Development and Deployment](docs/bmad/brownfield-architecture/development-and-deployment.md#testing)

**Test Framework:** Pytest with async support

**Test File Location:**
- Unit tests: `python/tests/server/config/test_config_confluence.py`

**Test Patterns:**
- Use `pytest` fixtures to mock environment variables with `monkeypatch`
- Test both success and failure validation paths
- Verify optional variables don't break startup
- Test URL validation edge cases (HTTP, malformed, empty)
- Mock bcrypt encryption/decryption for settings tests

**Required Test Coverage:**
1. **Configuration Loading Tests:**
   - Load config with all Confluence variables set
   - Load config with Confluence variables missing (should succeed)
   - Load config with invalid Confluence URL (should fail)
   - Verify optional status (no ConfigurationError when missing)

2. **URL Validation Tests:**
   - Valid Atlassian Cloud URL: `https://company.atlassian.net/wiki`
   - Valid custom domain: `https://wiki.company.com`
   - Invalid HTTP URL: `http://company.atlassian.net/wiki` (should fail)
   - Invalid format: `not-a-url` (should fail)
   - Empty string (should fail if validation called)

3. **Settings API Integration Tests:**
   - Store encrypted Confluence API token
   - Retrieve and decrypt API token
   - Verify bcrypt encryption applied
   - Test plain text settings (base_url, email)

**Running Tests:**
```bash
cd python
uv run pytest tests/server/config/test_config_confluence.py -v
uv run pytest  # All tests
```

### Integration Verification Requirements

**From Epic 1 Story 1.3 Acceptance Criteria:**

**IV1: `uv sync --group all` successfully installs new dependencies**
- Test: Run `uv sync --group all` in clean environment
- Validation: No errors, all dependencies resolve correctly
- Expected: `atlassian-python-api` and `markdownify` installed

**IV2: Settings service can retrieve and decrypt Confluence API token**
- Test: Store sample API token via Settings API with `is_encrypted=true`
- Validation: Retrieve token and verify it decrypts to original value
- Expected: Bcrypt encryption applied, decryption works correctly

**IV3: Missing environment variables raise clear ConfigurationError at startup**
- Test: Start server with invalid `CONFLUENCE_BASE_URL` (HTTP instead of HTTPS)
- Validation: Server fails to start with clear error message
- Expected: Error explains HTTPS requirement for Confluence Cloud

**Additional Verification:**
- Verify `.env.example` has clear examples and comments
- Verify `CLAUDE.md` documentation is accurate and complete
- Verify architecture docs updated to reflect implemented status

## Testing

### Test Framework
- Pytest 8.0+ with async support (`pytest-asyncio`)
- Fixtures for mocking environment variables (`monkeypatch` fixture)

### Test File Location
- `python/tests/server/config/test_config_confluence.py`

### Test Coverage Requirements
- Configuration loading with Confluence variables present/absent
- URL validation success/failure paths
- Settings API encryption/decryption integration
- Edge cases: malformed URLs, empty values, HTTP URLs

### Running Tests
```bash
cd python
uv run pytest tests/server/config/test_config_confluence.py -v  # This story's tests
uv run pytest tests/server/config/ -v                           # All config tests
uv run pytest                                                   # All tests
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Initial story creation from Epic 1 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- Claude 3.5 Sonnet (claude-sonnet-4-5@20250929)
- Agent: James (Full Stack Developer)

### Debug Log References
- None - All tasks completed without debugging required

### Completion Notes
**Tasks 3-5, 8-9 Completed:**
- Extended `EnvironmentConfig` dataclass with Confluence fields (base_url, api_token, email)
- Implemented `validate_confluence_url()` function with HTTPS enforcement and Atlassian Cloud / custom domain support
- Added URL validation to `load_environment_config()` (only runs if confluence_base_url provided)
- Documented Fernet encryption pattern for API tokens in code comments (CORRECTION: Uses Fernet, not bcrypt)
- Created comprehensive unit tests: 18 tests covering all validation scenarios
- Created integration tests: 5 tests verifying encryption/decryption flow with Settings API
- All 23 tests passing, linter clean

**Key Findings:**
1. Confluence integration uses **Fernet encryption** (symmetric), not bcrypt as mentioned in story notes
2. Encryption handled by existing `credential_service.py` - no new encryption code needed
3. API endpoint is `/api/credentials` (not `/api/settings` as initially documented)
4. Integration tests require database initialization via `credential_service.load_all_credentials()`

**Tasks 1-2 Status:**
- Already completed in Story 1.2 (dependencies in pyproject.toml, .env.example updated)

**Tasks 6-7 (Documentation) - COMPLETED:**
- **Task 6**: Updated `CLAUDE.md` with comprehensive Confluence environment variables section
  - Added "Confluence Integration (Optional)" subsection under Environment Variables
  - Documented all three variables (CONFLUENCE_BASE_URL, CONFLUENCE_API_TOKEN, CONFLUENCE_EMAIL)
  - Included configuration notes (optional at startup, Settings UI alternative, HTTPS requirement)
  - Added security section (Fernet encryption, credential_service.py reference)
- **Task 7**: Updated brownfield architecture documentation
  - Updated external services table: Confluence status "Planned" â†’ "Active"
  - Renamed section from "To Implement" to "Implemented"
  - Added dependencies with exact versions (atlassian-python-api>=3.41.0, markdownify>=0.11.0)
  - Documented environment variables with configuration pattern
  - Added implementation files references (config.py lines, test files)
  - Included code example with Confluence Cloud mode

### File List
**Modified Files:**
- `python/src/server/config/config.py` - Added Confluence fields, validation function, environment loading
- `CLAUDE.md` - Added Confluence Integration section under Environment Variables
- `docs/bmad/brownfield-architecture/integration-points-and-external-dependencies.md` - Updated Confluence status to "Implemented"
- `docs/bmad/stories/1.3.add-confluence-dependencies-and-configuration.md` - Task checkboxes, Dev Agent Record

**New Files:**
- `python/tests/server/config/__init__.py` - Test package marker
- `python/tests/server/config/test_config_confluence.py` - 18 unit tests for configuration validation
- `python/tests/server/config/test_confluence_settings_integration.py` - 5 integration tests for Settings API

## QA Results

### Review Date: 2025-10-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** âœ…

This story demonstrates exemplary implementation quality with comprehensive test coverage, robust validation logic, and thorough documentation. The configuration management follows security best practices with proper encryption handling and clear separation between optional and required configuration.

**Key Strengths:**
1. **Comprehensive Test Coverage**: 23 tests total (18 unit + 5 integration) covering all acceptance criteria
2. **Security-First Design**: Fernet encryption for API tokens, HTTPS enforcement, no credential exposure
3. **Excellent Error Handling**: Clear, actionable error messages with user guidance
4. **Documentation Excellence**: Inline code documentation, comprehensive user guide in CLAUDE.md, architecture updates
5. **Validation Robustness**: Multiple edge cases covered (trailing slashes, ports, subdomains, custom domains)

### Refactoring Performed

No refactoring was needed. The implementation is clean, well-structured, and follows established patterns in the codebase.

### Compliance Check

- **Coding Standards**: âœ“ PASS
  - Ruff linting: All checks passed
  - MyPy type checking: No errors in reviewed files (config.py clean)
  - 120-character line length adhered to
  - Proper docstrings with type hints

- **Project Structure**: âœ“ PASS
  - Tests in correct location: `python/tests/server/config/`
  - Integration tests properly isolated with `@pytest.mark.skipif`
  - Module organization follows existing patterns

- **Testing Strategy**: âœ“ PASS
  - Unit tests for all validation functions (8 URL validation, 6 config loading, 4 edge cases)
  - Integration tests for Settings API encryption flow (5 comprehensive tests)
  - Edge case coverage (trailing slashes, ports, subdomains, malformed URLs)
  - Proper mocking with `@patch.dict` for environment variables

- **All ACs Met**: âœ“ PASS
  - AC1: Dependencies already added in Story 1.2 (atlassian-python-api>=3.41.0, markdownify>=0.11.0) âœ“
  - AC2: .env.example updated with all three variables and clear comments âœ“
  - AC3: EnvironmentConfig extended with Confluence fields, validation implemented âœ“
  - AC4: Fernet encryption documented, credential_service integration verified âœ“
  - AC5: CLAUDE.md and brownfield-architecture.md comprehensively updated âœ“

### Improvements Checklist

All items handled during implementation - no remaining work:

- [x] Extended EnvironmentConfig dataclass with Confluence fields (config.py:29-35)
- [x] Implemented validate_confluence_url() with HTTPS enforcement (config.py:145-189)
- [x] Added optional Confluence variable loading with URL validation (config.py:259-266)
- [x] Created 18 unit tests covering all validation scenarios (test_config_confluence.py)
- [x] Created 5 integration tests verifying encryption flow (test_confluence_settings_integration.py)
- [x] Updated .env.example with comprehensive Confluence section (lines 57-62)
- [x] Updated CLAUDE.md with Confluence Integration documentation (lines 213-232)
- [x] Updated brownfield-architecture integration-points doc with implementation details

### Security Review

**Security Assessment: PASS** âœ“

**Positive Findings:**
1. **Encryption Implementation**: Fernet symmetric encryption properly used via credential_service
2. **HTTPS Enforcement**: validate_confluence_url() rejects non-HTTPS URLs (Confluence Cloud requirement)
3. **No Credential Exposure**: API tokens never logged, clear comments warning against logging
4. **URL Validation**: Prevents injection attacks via strict URL parsing and validation
5. **Optional Configuration**: No ConfigurationError raised when Confluence vars missing (graceful degradation)

**Architecture Patterns:**
- API token encryption uses existing credential_service.py (Fernet encryption)
- API endpoint: `POST /api/credentials` with `is_encrypted=true`
- Integration tests verify encryption/decryption round-trip
- Plaintext storage only for non-sensitive data (URL, email)

**No security issues identified.**

### Performance Considerations

**Performance Assessment: PASS** âœ“

**Analysis:**
1. **Validation Overhead**: Minimal - URL parsing and string checks (~microseconds)
2. **Startup Impact**: Only validates if confluence_base_url provided (optional check)
3. **Database Impact**: No additional queries at startup (Settings API used on-demand)
4. **Memory Footprint**: Three optional string fields in EnvironmentConfig dataclass (negligible)

**No performance concerns identified.**

### Files Modified During Review

None - no modifications were needed. Implementation is production-ready.

**Note to Dev:** File List in Dev Agent Record is accurate. No updates needed.

### Test Execution Results

All tests passing:

```bash
# Unit Tests (18 tests)
uv run pytest tests/server/config/test_config_confluence.py -v
======================== 18 passed in 0.13s ========================

# Linting
uv run ruff check src/server/config/config.py tests/server/config/
======================== All checks passed! ========================
```

**Integration tests** (`test_confluence_settings_integration.py`):
- Skipped in CI when no Supabase database available (proper pattern)
- Verified locally with test database: 5 tests PASS
- Cleanup properly implemented in `finally` blocks

### Gate Status

**Gate: PASS** â†’ [docs/bmad/qa/gates/1.3-add-confluence-dependencies-and-configuration.yml](../qa/gates/1.3-add-confluence-dependencies-and-configuration.yml)

**Quality Score: 100/100**

**Risk Profile**: No risks identified (0 critical, 0 high, 0 medium, 0 low)

### Recommended Status

**âœ“ Ready for Done**

This story is production-ready with no blocking issues. All acceptance criteria met, comprehensive test coverage, and excellent documentation. The implementation follows security best practices and integrates seamlessly with existing architecture.

**Optional Future Enhancements** (not blocking):
1. Email format validation (RFC 5322) - currently accepts any string
2. Integration test with real Confluence instance (requires test environment setup)

**Decision:** Story owner may proceed to mark status as "Done"
